import type {IconProps} from "@iconify/react";

import {Icon} from "@iconify/react";
import gravityIcons from "@iconify-json/gravity-ui/icons.json";
import {forwardRef, useId, useMemo} from "react";

export type IconifyProps = IconProps & {
  icon?: IconProps["icon"] | string;
};

// Helper component to render SVG directly from icon data
// This ensures consistent rendering between SSR and client
// React 19 supports passing refs through props directly
function SVGFromIconData({
  iconData,
  ref,
  ...props
}: {
  iconData: {body: string; width?: number; height?: number};
  ref?: React.Ref<SVGSVGElement>;
} & Omit<IconProps, "icon">) {
  const {className, height = "1em", style, width = "1em", ...restProps} = props;

  const viewBox =
    iconData.width && iconData.height ? `0 0 ${iconData.width} ${iconData.height}` : "0 0 16 16";

  const uniqueId = useId().replace(/:/g, "");

  const processedBody = useMemo(() => {
    const {body} = iconData;

    if (!body.includes("id=")) {
      return body;
    }

    const regex = /\bid=["']([^"']+)["']|url\(#([^)]+)\)|(?:href|xlink:href)=["']#([^"']+)["']/g;

    return body.replace(regex, (match, g1, g2, g3) => {
      const id = g1 || g2 || g3;

      if (!id) return match;

      const newId = `${id}-${uniqueId}`;

      if (g1) return `id="${newId}"`;
      if (g2) return `url(#${newId})`;
      if (g3) return `href="#${newId}"`;

      return match;
    });
  }, [iconData.body, uniqueId]);

  return (
    <svg
      ref={ref}
      aria-hidden="true"
      className={className}
      height={height}
      role="img"
      style={style}
      viewBox={viewBox}
      width={width}
      xmlns="http://www.w3.org/2000/svg"
      xmlnsXlink="http://www.w3.org/1999/xlink"
      {...restProps}
      dangerouslySetInnerHTML={{__html: processedBody}}
    />
  );
}

const customIcons = {
  "bulb-off": {
    body: '<path fill-rule="evenodd" clip-rule="evenodd" d="M6.26 15.1091C6.8026 15.3712 7.39741 15.5073 8 15.5073C8.6026 15.5073 9.19741 15.3712 9.74 15.1091L9.87 15.0461C10.2085 14.8825 10.494 14.627 10.6939 14.3086C10.8937 13.9902 10.9998 13.622 11 13.2461V12.7781C11 11.4261 11.776 10.2211 12.54 9.10507C13.105 8.27879 13.4339 7.31397 13.491 6.3146C13.5482 5.31524 13.3315 4.31922 12.8644 3.43389C12.3973 2.54857 11.6974 1.80751 10.8402 1.29059C9.98302 0.77367 9.001 0.500488 8 0.500488C6.999 0.500488 6.01698 0.77367 5.15978 1.29059C4.30258 1.80751 3.6027 2.54857 3.13558 3.43389C2.66846 4.31922 2.45181 5.31524 2.50898 6.3146C2.56615 7.31397 2.89497 8.27879 3.46 9.10507C4.224 10.2211 5 11.4261 5 12.7791V13.2461C4.99998 13.6221 5.10598 13.9906 5.30586 14.3092C5.50573 14.6277 5.79137 14.8835 6.13 15.0471L6.26 15.1091ZM9.088 13.7591L9.218 13.6951C9.30253 13.6541 9.37381 13.5902 9.42368 13.5106C9.47356 13.431 9.50001 13.339 9.5 13.2451V12.7781C9.5 12.6081 9.50833 12.4414 9.525 12.2781C8.53004 12.5752 7.46996 12.5752 6.475 12.2781C6.491 12.4414 6.49933 12.6081 6.5 12.7781V13.2451C6.5 13.339 6.52645 13.431 6.57632 13.5106C6.62619 13.5902 6.69748 13.6541 6.782 13.6951L6.912 13.7581C7.25126 13.9221 7.62319 14.0072 8 14.0072C8.37681 14.0072 8.74875 13.9231 9.088 13.7591ZM4.698 8.25707C5.092 8.83307 5.589 9.55907 5.961 10.4051C6.57004 10.7938 7.27749 11.0003 8 11.0003C8.72251 11.0003 9.42996 10.7938 10.039 10.4051C10.411 9.55907 10.908 8.83307 11.303 8.25707C11.7137 7.6561 11.9526 6.95445 11.994 6.22773C12.0354 5.50101 11.8778 4.77677 11.538 4.13304C11.1982 3.48931 10.6892 2.95049 10.0659 2.57465C9.4425 2.19881 8.7284 2.00019 8.0005 2.00019C7.2726 2.00019 6.5585 2.19881 5.93514 2.57465C5.31178 2.95049 4.8028 3.48931 4.46302 4.13304C4.12325 4.77677 3.96557 5.50101 4.00698 6.22773C4.04839 6.95445 4.28731 7.6561 4.698 8.25707Z" fill="currentColor"/>',
  },
  figma: {
    body: '<path d="M3.75 4.5C3.75 3.70435 4.06607 2.94129 4.62868 2.37868C5.19129 1.81607 5.95435 1.5 6.75 1.5H11.25C11.8594 1.49996 12.4543 1.6855 12.9557 2.03193C13.457 2.37835 13.8409 2.86924 14.0564 3.43925C14.2719 4.00927 14.3086 4.63139 14.1618 5.22281C14.015 5.81424 13.6915 6.34693 13.2345 6.75C13.7935 7.24186 14.1496 7.92403 14.2336 8.66387C14.3176 9.40371 14.1235 10.1484 13.6889 10.753C13.2544 11.3577 12.6106 11.7791 11.8826 11.9354C11.1546 12.0917 10.3944 11.9717 9.75 11.5988V13.5C9.74997 14.0013 9.62433 14.4946 9.38455 14.9348C9.14477 15.375 8.7985 15.7482 8.37738 16.0201C7.95626 16.292 7.4737 16.4541 6.97381 16.4915C6.47392 16.5289 5.97262 16.4404 5.51573 16.2342C5.05883 16.0279 4.6609 15.7105 4.35829 15.3108C4.05567 14.9112 3.85803 14.4421 3.78342 13.9464C3.7088 13.4507 3.7596 12.9442 3.93115 12.4731C4.10271 12.0021 4.38956 11.5816 4.7655 11.25C4.44631 10.9685 4.19069 10.6222 4.0156 10.2343C3.84052 9.84636 3.74998 9.42561 3.75 9C3.74998 8.57439 3.84052 8.15364 4.0156 7.76571C4.19069 7.37778 4.44631 7.03154 4.7655 6.75C4.44631 6.46846 4.19069 6.12222 4.0156 5.73429C3.84052 5.34636 3.74998 4.92561 3.75 4.5ZM8.25 7.5H6.75C6.35218 7.5 5.97065 7.65804 5.68934 7.93934C5.40804 8.22064 5.25 8.60218 5.25 9C5.25 9.39782 5.40804 9.77936 5.68934 10.0607C5.97065 10.342 6.35218 10.5 6.75 10.5H8.25V7.5ZM9.75 9C9.75 9.39782 9.90804 9.77936 10.1893 10.0607C10.4706 10.342 10.8522 10.5 11.25 10.5C11.6478 10.5 12.0294 10.342 12.3107 10.0607C12.592 9.77936 12.75 9.39782 12.75 9C12.75 8.60218 12.592 8.22064 12.3107 7.93934C12.0294 7.65804 11.6478 7.5 11.25 7.5C10.8522 7.5 10.4706 7.65804 10.1893 7.93934C9.90804 8.22064 9.75 8.60218 9.75 9ZM11.25 6C11.6478 6 12.0294 5.84196 12.3107 5.56066C12.592 5.27936 12.75 4.89782 12.75 4.5C12.75 4.10218 12.592 3.72064 12.3107 3.43934C12.0294 3.15804 11.6478 3 11.25 3H9.75V6H11.25ZM6.75 3C6.35218 3 5.97065 3.15804 5.68934 3.43934C5.40804 3.72064 5.25 4.10218 5.25 4.5C5.25 4.89782 5.40804 5.27936 5.68934 5.56066C5.97065 5.84196 6.35218 6 6.75 6H8.25V3H6.75ZM8.25 12H6.75C6.45333 12 6.16332 12.088 5.91665 12.2528C5.66997 12.4176 5.47771 12.6519 5.36418 12.926C5.25065 13.2001 5.22094 13.5017 5.27882 13.7926C5.3367 14.0836 5.47956 14.3509 5.68934 14.5607C5.89912 14.7704 6.16639 14.9133 6.45737 14.9712C6.74834 15.0291 7.04994 14.9994 7.32403 14.8858C7.59811 14.7723 7.83238 14.58 7.99721 14.3334C8.16203 14.0867 8.25 13.7967 8.25 13.5V12Z" fill="currentColor"/>',
  },
  "layout-header-cursor": {
    body: '<path d="M3 2H11C11.8284 2 12.5 2.67157 12.5 3.5V7.25C12.5 7.66421 12.8358 8 13.25 8C13.6642 8 14 7.66421 14 7.25V3.5C14 1.84315 12.6569 0.5 11 0.5H3C1.34315 0.5 0 1.84315 0 3.5V9C0 10.6569 1.34315 12 3 12H5.75C6.16421 12 6.5 11.6642 6.5 11.25C6.5 10.8358 6.16421 10.5 5.75 10.5H3C2.17157 10.5 1.5 9.82843 1.5 9V3.5C1.5 2.67157 2.17157 2 3 2Z" fill="currentColor"/><path d="M9.22766 7.17179C9.00375 6.98682 8.69317 6.94775 8.43043 7.0715C8.16768 7.19525 8 7.45958 8 7.75001V13.2935C8 13.6119 8.201 13.8955 8.50136 14.0011C8.80172 14.1066 9.13598 14.011 9.33514 13.7627L10.2726 12.5606L11.0792 14.3354C11.2644 14.7059 11.7149 14.8561 12.0854 14.6708C12.4559 14.4856 12.6061 14.0351 12.4208 13.6646L11.594 12.0109H13C13.3164 12.0109 13.5987 11.8124 13.7058 11.5147C13.8128 11.217 13.7216 10.8841 13.4777 10.6827L9.22766 7.17179Z" fill="currentColor"/>',
  },
  "layout-selector-cursor": {
    body: '<path fill-rule="evenodd" clip-rule="evenodd" d="M6.82025 1.72753C6.82025 1.53458 6.7436 1.34953 6.60716 1.21309C6.47072 1.07665 6.28567 1 6.09272 1C5.89976 1 5.71471 1.07665 5.57828 1.21309C5.44184 1.34953 5.36519 1.53458 5.36519 1.72753V3.18259C5.36519 3.37555 5.44184 3.5606 5.57828 3.69704C5.71471 3.83347 5.89976 3.91012 6.09272 3.91012C6.28567 3.91012 6.47072 3.83347 6.60716 3.69704C6.7436 3.5606 6.82025 3.37555 6.82025 3.18259V1.72753ZM3.52017 2.49144C3.45306 2.42195 3.37278 2.36653 3.28401 2.3284C3.19525 2.29027 3.09979 2.2702 3.00319 2.26936C2.90658 2.26852 2.81078 2.28693 2.72137 2.32351C2.63196 2.36009 2.55073 2.41411 2.48242 2.48242C2.41411 2.55073 2.36009 2.63196 2.32351 2.72137C2.28693 2.81078 2.26852 2.90658 2.26936 3.00319C2.2702 3.09979 2.29027 3.19525 2.3284 3.28401C2.36653 3.37278 2.42195 3.45306 2.49144 3.52017L3.52017 4.55035C3.58781 4.61799 3.66811 4.67165 3.75649 4.70826C3.84487 4.74487 3.9396 4.76371 4.03526 4.76371C4.13092 4.76371 4.22565 4.74487 4.31403 4.70826C4.40241 4.67165 4.48271 4.61799 4.55035 4.55035C4.61799 4.48271 4.67165 4.40241 4.70826 4.31403C4.74487 4.22565 4.76371 4.13092 4.76371 4.03526C4.76371 3.9396 4.74487 3.84487 4.70826 3.75649C4.67165 3.66811 4.61799 3.58781 4.55035 3.52017L3.52017 2.49144ZM6.66747 5.51797C5.95667 5.28079 5.28079 5.95667 5.51797 6.66747L8.08761 14.3778C8.34734 15.1578 9.42627 15.2203 9.77403 14.4753L11.2698 11.2698L14.4753 9.77475C15.2203 9.42699 15.1578 8.34734 14.3778 8.08761L6.66747 5.51797ZM9.03485 12.6187L7.24294 7.24294L12.6194 9.03485L10.4746 10.0352C10.2811 10.1255 10.1255 10.2811 10.0352 10.4746L9.03485 12.6187ZM9.694 2.49144C9.83039 2.62787 9.90701 2.81289 9.90701 3.0058C9.90701 3.19872 9.83039 3.38374 9.694 3.52017L8.66527 4.55035C8.59767 4.61795 8.51743 4.67157 8.42911 4.70815C8.34079 4.74473 8.24613 4.76356 8.15054 4.76356C8.05495 4.76356 7.96029 4.74473 7.87197 4.70815C7.78365 4.67157 7.70341 4.61795 7.63581 4.55035C7.56822 4.48276 7.5146 4.40251 7.47802 4.31419C7.44143 4.22588 7.4226 4.13122 7.4226 4.03562C7.4226 3.94003 7.44143 3.84537 7.47802 3.75705C7.5146 3.66874 7.56822 3.58849 7.63581 3.5209L8.66527 2.49217C8.8017 2.35578 8.98672 2.27916 9.17963 2.27916C9.37255 2.27916 9.55756 2.35505 9.694 2.49144ZM1 6.09272C1 5.89976 1.07665 5.71471 1.21309 5.57828C1.34953 5.44184 1.53458 5.36519 1.72753 5.36519H3.18259C3.37555 5.36519 3.5606 5.44184 3.69704 5.57828C3.83347 5.71471 3.91012 5.89976 3.91012 6.09272C3.91012 6.28567 3.83347 6.47072 3.69704 6.60716C3.5606 6.7436 3.37555 6.82025 3.18259 6.82025H1.72753C1.53458 6.82025 1.34953 6.7436 1.21309 6.60716C1.07665 6.47072 1 6.28567 1 6.09272ZM4.54962 8.66527C4.61722 8.59772 4.67085 8.51752 4.70745 8.42925C4.74405 8.34097 4.7629 8.24636 4.76294 8.1508C4.76297 8.05524 4.74418 7.96061 4.70765 7.87231C4.67111 7.78401 4.61754 7.70377 4.54999 7.63618C4.48244 7.56858 4.40224 7.51495 4.31397 7.47835C4.22569 7.44175 4.13108 7.4229 4.03552 7.42286C3.93996 7.42283 3.84533 7.44162 3.75703 7.47815C3.66873 7.51469 3.58849 7.56826 3.5209 7.63581L2.49144 8.666C2.35502 8.80251 2.27842 8.98762 2.27849 9.18062C2.27856 9.37361 2.35529 9.55867 2.4918 9.69509C2.62832 9.83151 2.81343 9.90811 3.00642 9.90804C3.19942 9.90797 3.38448 9.83124 3.5209 9.69472L4.54962 8.66527Z"/>',
  },
  openai: {
    body: '<path fill="currentColor" d="M14.949 6.547a3.94 3.94 0 0 0-.348-3.273a4.11 4.11 0 0 0-4.4-1.934A4.1 4.1 0 0 0 8.423.2A4.15 4.15 0 0 0 6.305.086a4.1 4.1 0 0 0-1.891.948a4.04 4.04 0 0 0-1.158 1.753a4.1 4.1 0 0 0-1.563.679A4 4 0 0 0 .554 4.72a3.99 3.99 0 0 0 .502 4.731a3.94 3.94 0 0 0 .346 3.274a4.11 4.11 0 0 0 4.402 1.933c.382.425.852.764 1.377.995c.526.231 1.095.35 1.67.346c1.78.002 3.358-1.132 3.901-2.804a4.1 4.1 0 0 0 1.563-.68a4 4 0 0 0 1.14-1.253a3.99 3.99 0 0 0-.506-4.716m-6.097 8.406a3.05 3.05 0 0 1-1.945-.694l.096-.054l3.23-1.838a.53.53 0 0 0 .265-.455v-4.49l1.366.778q.02.011.025.035v3.722c-.003 1.653-1.361 2.992-3.037 2.996m-6.53-2.75a2.95 2.95 0 0 1-.36-2.01l.095.057L5.29 12.09a.53.53 0 0 0 .527 0l3.949-2.246v1.555a.05.05 0 0 1-.022.041L6.473 13.3c-1.454.826-3.311.335-4.15-1.098m-.85-6.94A3.02 3.02 0 0 1 3.07 3.949v3.785a.51.51 0 0 0 .262.451l3.93 2.237l-1.366.779a.05.05 0 0 1-.048 0L2.585 9.342a2.98 2.98 0 0 1-1.113-4.094zm11.216 2.571L8.747 5.576l1.362-.776a.05.05 0 0 1 .048 0l3.265 1.86a3 3 0 0 1 1.173 1.207a2.96 2.96 0 0 1-.27 3.2a3.05 3.05 0 0 1-1.36.997V8.279a.52.52 0 0 0-.276-.445m1.36-2.015l-.097-.057l-3.226-1.855a.53.53 0 0 0-.53 0L6.249 6.153V4.598a.04.04 0 0 1 .019-.04L9.533 2.7a3.07 3.07 0 0 1 3.257.139c.474.325.843.778 1.066 1.303c.223.526.289 1.103.191 1.664zM5.503 8.575L4.139 7.8a.05.05 0 0 1-.026-.037V4.049c0-.57.166-1.127.476-1.607s.752-.864 1.275-1.105a3.08 3.08 0 0 1 3.234.41l-.096.054l-3.23 1.838a.53.53 0 0 0-.265.455zm.742-1.577l1.758-1l1.762 1v2l-1.755 1l-1.762-1z"/>',
  },
};

const icons = {
  ...gravityIcons.icons,
  ...customIcons,
};

const Iconify = forwardRef<SVGSVGElement, IconifyProps>(({icon: iconProp, ...props}, ref) => {
  // Check if it's a gravity-ui icon (no prefix or explicitly in gravity icons)
  const isGravityIcon =
    typeof iconProp === "string" && (iconProp in icons || iconProp.startsWith("gravity-ui:"));

  // For gravity-ui icons, render SVG directly from icon data
  // This ensures consistent rendering between SSR and client, avoiding hydration mismatch
  if (isGravityIcon && typeof iconProp === "string") {
    // Remove "gravity-ui:" prefix if present
    const iconName = iconProp.replace(/^gravity-ui:/, "");
    const gravityIconData = icons[iconName as keyof typeof icons];

    if (gravityIconData) {
      return <SVGFromIconData ref={ref} iconData={gravityIconData} {...props} />;
    }
  }

  // Use online version for other icon sets (like simple-icons:vite, lineicons:nextjs)
  // Icon component supports SSR, so this works consistently on both server and client
  return (
    <Icon
      {...props}
      ref={ref}
      fallback={<SVGFromIconData iconData={icons["square"]} />}
      icon={iconProp}
    />
  );
});

Iconify.displayName = "HeroUI.Iconify";

export {Iconify};
